name: Version Update

on:
  workflow_dispatch:

jobs:
  increment_version:
    runs-on: windows-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Increment Version and Update Files
      shell: pwsh
      run: |
        # Path to AssemblyInfo.cs
        $assemblyInfoPath = "$(Get-ChildItem -Recurse -Filter AssemblyInfo.cs | Select-Object -First 1).FullName"

        # Read current version from AssemblyInfo.cs
        $assemblyContent = Get-Content $assemblyInfoPath
        $versionLine = $assemblyContent | Where-Object { $_ -match 'AssemblyVersion' }
        $currentVersion = ($versionLine -split '"')[1]

        # Split current version into components
        $versionParts = $currentVersion.Split('.')
        $major = [int]$versionParts[0]
        $minor = [int]$versionParts[1]
        $build = [int]$versionParts[2] + 1  # Increment the build number
        $revision = [int]$versionParts[3]

        # Construct new version
        $newVersion = "$major.$minor.$build.$revision"

        # Update AssemblyInfo.cs with the new version
        $assemblyContent = $assemblyContent | ForEach-Object {
          $_ -replace 'AssemblyVersion\(".*"\)', "AssemblyVersion(`"$newVersion`")"
        }
        $assemblyContent | Set-Content $assemblyInfoPath

        # Update updater.json with the new version
        $json = @{
          version = $newVersion
          url = "https://github.com/MrPcGamerYT/Optimizer/releases/latest/download/OptimizerSetup.exe"
        }
        $json | ConvertTo-Json -Compress | Set-Content update.json -Encoding UTF8

        Write-Host "Updated version to $newVersion"

    - name: Commit changes
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git add AssemblyInfo.cs update.json
        git commit -m "Increment version to $newVersion"
        git push
