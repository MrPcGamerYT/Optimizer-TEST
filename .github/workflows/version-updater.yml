name: Update Project Version

on:
  workflow_dispatch:   # Manual trigger

jobs:
  update-version:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
  
    - name: Generate update.json
      shell: pwsh
      run: |
        $json = @{
            version = "1.0.1"
            url     = "https://github.com/MrPcGamerYT/Optimizer/releases/latest/download/OptimizerSetup.exe"
        } | ConvertTo-Json -Compress
        $json | Set-Content -Path update.json -Encoding UTF8
        Write-Host "Generated update.json: $json"

    - name: Commit updater.json
      shell: pwsh
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git add update.json
        git commit -m "Update update.json to $env:VERSION" || echo "No changes"
        git push

    - name: Update AssemblyInfo.cs
      shell: pwsh
      run: |
        $assemblyPath = "Optimizer/Properties/AssemblyInfo.cs"
        if (-not (Test-Path $assemblyPath)) { Write-Error "AssemblyInfo.cs not found!"; exit 1 }

        $version = 1.0.1
        $content = Get-Content $assemblyPath -Raw

        # Replace AssemblyVersion and AssemblyFileVersion lines
        $content = $content -replace 'AssemblyVersion\(".*"\)', "AssemblyVersion(`"$version`")"
        $content = $content -replace 'AssemblyFileVersion\(".*"\)', "AssemblyFileVersion(`"$version`")"

        # Save the updated AssemblyInfo.cs
        $content | Set-Content $assemblyPath -Encoding UTF8

        Write-Host "AssemblyInfo.cs updated to version $version"

    # 3️⃣ Commit changes
    - name: Commit updated AssemblyInfo.cs
      shell: pwsh
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git add Optimizer/Properties/AssemblyInfo.cs
        git commit -m "Update AssemblyInfo.cs to version $version" || echo "No changes"
        git push
