name: Update Project Version

on:
  workflow_dispatch:   # Manual trigger

jobs:
  update-version:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    # 1️⃣ Read updater.json version
    - name: Read version from updater.json
      shell: pwsh
      run: |
        $jsonPath = "update.json"
        if (-not (Test-Path $jsonPath)) { Write-Error "update.json not found!"; exit 1 }
        $json = Get-Content $jsonPath | ConvertFrom-Json
        $version = $json.version
        if ([string]::IsNullOrWhiteSpace($version)) { Write-Error "Version is empty!"; exit 1 }
        Write-Host "APP_VERSION=$version" >> $env:GITHUB_ENV

    # 2️⃣ Update AssemblyInfo.cs using regex replacement (like csproj)
    - name: Update AssemblyInfo.cs
      shell: pwsh
      run: |
        $assemblyPath = "Optimizer/Properties/AssemblyInfo.cs"
        if (-not (Test-Path $assemblyPath)) { Write-Error "AssemblyInfo.cs not found!"; exit 1 }

        $version = $env:APP_VERSION
        $content = Get-Content $assemblyPath -Raw

        # Replace AssemblyVersion and AssemblyFileVersion lines
        $content = $content -replace 'AssemblyVersion\(".*"\)', "AssemblyVersion(`"$version`")"
        $content = $content -replace 'AssemblyFileVersion\(".*"\)', "AssemblyFileVersion(`"$version`")"

        # Save the updated AssemblyInfo.cs
        $content | Set-Content $assemblyPath -Encoding UTF8

        Write-Host "AssemblyInfo.cs updated to version $version"


    # 3️⃣ Update .csproj version
    - name: Update csproj version
      shell: pwsh
      run: |
          $projectFile = Get-ChildItem -Recurse -Filter "*.csproj" | Select-Object -First 1 -ExpandProperty FullName
          [xml]$csproj = Get-Content $projectFile

          # Find the first PropertyGroup that has a Version node
          $pg = $csproj.Project.PropertyGroup | Where-Object { $_.Version } | Select-Object -First 1

          if (-not $pg) {
          # If no Version node exists, create it
          $pg = $csproj.Project.PropertyGroup[0]
          $versionNode = $csproj.CreateElement("Version")
          $pg.AppendChild($versionNode) | Out-Null
          $pg = $pg  # reassign for innertext
          $pg.Version = $versionNode
          }

          # Set the InnerText of Version, FileVersion, and AssemblyVersion
          $pg.Version.InnerText = $env:APP_VERSION

          # Also update FileVersion and AssemblyVersion nodes if they exist
          if (-not $pg.FileVersion) {
          $fileNode = $csproj.CreateElement("FileVersion")
          $pg.AppendChild($fileNode) | Out-Null
          }
          $pg.FileVersion.InnerText = $env:APP_VERSION

          if (-not $pg.AssemblyVersion) {
          $assemblyNode = $csproj.CreateElement("AssemblyVersion")
          $pg.AppendChild($assemblyNode) | Out-Null
          }
          $pg.AssemblyVersion.InnerText = $env:APP_VERSION

          # Save the csproj
          $csproj.Save($projectFile)
          Write-Host "$projectFile version updated to $env:APP_VERSION"


    # 4️⃣ Commit changes
    - name: Commit updated files
      shell: pwsh
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git add Optimizer/Properties/AssemblyInfo.cs
        git add *.csproj
        git commit -m "Update AssemblyInfo.cs and .csproj to version $env:APP_VERSION" || echo "No changes"
        git push
